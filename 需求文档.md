## 桥梁定检可视化需求文档（统一版）

> 本文档整合了需求说明、角色与多端功能分析，作为单一真实来源（Single Source of Truth）。后续所有讨论、迭代仅需维护此文档。

---

### 1. 项目概览
- **项目背景**：上海市桥梁定期检查业务亟需数字化监管能力，业主希望实时掌握第三方检测单位的作业情况，确保履约可视、可溯、可管。
- **核心诉求**：
  1. 检测人员必须随身佩戴智能终端（JX-P2 执法记录仪等），实现定位、音视频回传、对讲。
  2. 管理部门希望在大屏实时看到正在作业的视频画面，并可随时语音指挥。
  3. 平台需要支撑多租户（市/区主管单位）场景，对接多家检测服务商。
- **设计原则**：流程简单、操作可控；以后端自动匹配、实时监管为目标，减少复杂排班与人工维护成本。

---

### 2. 目标与范围
- 在既有桥梁管理系统中新增“定检可视化模块”，覆盖定检计划、现场执行、实时监督、履约核查的闭环。
- 支撑多终端协同：PC 大屏监管 + 微信小程序（含 H5 备选）巡检端。
- 形成 SaaS 化能力，可开通多个主管单位租户，统一运维。
- 分阶段推进：优先兑现“打卡即视频”“大屏监管”“语音对讲”等核心体验，再逐步扩展数据分析与智能能力。

---

### 3. 用户角色体系

```
平台超级管理员（SaaS 运营方）
  └── 租户（主管单位）
      ├── 主管单位管理员（市级 / 区级）
      │   └── 执行单位管理员（检测服务商）
      │       └── 检测人员（现场作业）
```

#### 3.1 角色概述
- **平台超级管理员**：运营平台，开通租户、管理计费、维护平台级参数，不参与具体业务。
- **主管单位管理员**：主管部门的核心使用者，合并原监管、运维、计划管理职能，负责定检计划维护、实时监督、数据分析。
- **执行单位管理员**：检测服务商负责人，负责设备登记、人员管理、现场数据审核。
- **检测人员**：现场执行者，使用小程序 + 执法记录仪完成打卡、视频回传、数据采集。

---

### 4. 多端定位与能力分配

| 角色 | Web 能力 | 小程序/H5 能力 |
| --- | --- | --- |
| 平台超级管理员 | 租户开通、平台参数配置、计费监控、全局日志审计 | - |
| 主管单位管理员 | 定检计划维护、实时大屏、视频墙、对讲、告警处理、报表分析、权限管理 | 应急查看、消息提醒、对讲指令 |
| 执行单位管理员 | 设备登记、人员管理、作业总览、数据审核、统计报表 | 作业进度速览、消息提醒 |
| 检测人员 | - | 打卡、选择项目包/路线/路段、自动开视频、数据采集、对讲、消息中心 |

---

### 5. 业务流程（轻量模式）

#### 5.1 前置配置
1. **主管单位管理员**在平台维护《定检项目包 → 路线 → 路段》清单，以及检查标准。
2. **执行单位管理员**自购设备并登记（型号、SN、采购信息、所属项目包），绑定至本单位。
3. **检测人员信息**由执行单位管理员维护并绑定设备（可临时解绑/重绑）。

#### 5.2 现场作业流程
1. 检测人员抵达现场 → 打开小程序 → “开工打卡”。
2. 打卡页要求选择“项目包 → 路线 → 路段”，系统校验是否存在于当前租户的定检计划。
3. 打卡成功后，系统尝试自动触发设备视频回传、音频对讲通道，并开始记录定位轨迹；若终端不支持自动推流，则提示检测人员在设备上手动开启。
4. 检测人员按要求执行检查，可同步上传表单、照片、短视频等数据。
5. 作业完成后，检测人员点击“收工打卡”，结束音视频流，提交检查结果。

#### 5.3 管理监管流程
1. 大屏实时显示“正在作业”人员列表，按项目包/路线分组，自动播放视频缩略窗口。
2. 管理员可点击某人员，进入单路视频，对其发起语音对讲（PTT 或全双工）。
3. 支持同时监看多路视频，并在地图上查看人员位置、轨迹。
4. 作业结束后数据沉淀，可用于履约核查、报表统计。

---

### 6. 核心功能需求

#### 6.1 设备与人员管理（执行单位为主）
- **设备登记**：录入设备型号、SN、采购/启用信息；支持上传采购凭证；按项目包/标段归类。
- **设备激活与绑定**：设备需绑定执行单位并与检测人员关联；支持临时解绑，操作有审计。
- **设备状态监控**：展示在线/离线、电量、信号、视频回传状态；统计使用时长、故障率。
- **人员管理**：维护检测人员档案、证书；人员与设备绑定关系管理。
- **维护记录**：记录故障、维修、保养计划，故障时可标记不可用。

#### 6.2 定检计划管理（主管单位为主）
- 维护《项目包 → 路线 → 路段》清单，包含桥梁列表、作业频次、检查标准。
- 支持按行政区域、路段类型筛选；具备版本管理与审批流程（草稿→发布→调整）。
- 计划发布后对执行单位开放，仅作为检测人员打卡选择项的合法来源。

#### 6.3 作业管理与打卡
- 打卡选择：检测人员打卡时必须选择合法的项目包/路线/路段组合。
- 设备校验：打卡流程校验设备是否已绑定、状态正常；无效则阻止开工。
- 自动开视频：打卡成功后调用执法记录仪 SDK 自动推流，若 10 秒内未上线视频则提示人工手动开启并同步告警。
- 作业过程：持续上传定位轨迹、视频、音频；支持一键求援。
- 收工打卡：关闭视频流、提交检查记录（表单、照片、附件）。

#### 6.4 实时监督与对讲
- **视频墙**：展示所有“作业中”人员的视频缩略窗，支持一键放大。
- **地图联动**：地图上显示正在作业的人员位置，视频/轨迹联动。
- **语音对讲**：管理员点击人员即可发起语音呼叫，支持单呼、群呼、广播；记录对讲日志。
- **指令记录**：对讲中可快速下发指令，要求检测人员确认并回传执行情况。

#### 6.5 定位与轨迹
- 实时定位：PC 大屏和移动端可查看实时位置。
- 轨迹回放：支持按时间范围回放轨迹，展示停留点、速度。
- 合规校验：核对轨迹是否落在所选路线内，超界/长时间静止触发告警。

#### 6.6 履约核查与告警
- 自动比对打卡、轨迹、视频时长，生成履约评分。
- 告警规则：设备离线、视频中断、超时未打卡、超界作业等。
- 告警处理：PC 大屏和小程序推送，支持确认、整改、闭环流程。

#### 6.7 数据分析与报表
- KPI：完成率、异常次数、平均作业时长、设备在线率等。
- 维度：市级/区级/执行单位/项目包/路线。
- 报表导出：Excel/PDF，支持定时发送。

#### 6.8 系统与权限
- 用户、角色、数据权限：按照租户、执行单位、项目包分级控制。
- 操作审计：关键操作（打卡、对讲、告警处理、设备变更）必须留痕。
- 参数配置：地图底图、告警阈值、设备型号、视频码率等。

---

### 7. SaaS 多租户设计
- **租户隔离**：数据层通过 `tenant_id` 或独立库实现；视频流、对象存储按租户分区。
- **租户开通流程**：
  1. 平台超级管理员录入租户信息、设置功能权限、初始化管理员账号。
  2. 租户管理员登录后完善信息、创建执行单位、分配角色。
- **计费监控**：记录租户的设备数、视频流量、存储用量，为后续计费准备。
- **配置隔离**：每个租户可以自定义大屏主题、LOGO、告警策略。

---

### 8. 多端功能清单

| 模块 | 子功能 | 检测人员（小程序） | 执行单位管理员（Web/小程序） | 主管单位管理员（Web/小程序） | 平台超级管理员（Web） |
| --- | --- | --- | --- | --- | --- |
| 登录认证 | 企业微信 / 手机验证码 / 账号密码、多因素 | ✅ | ✅ | ✅ | ✅ |
| 设备管理 | 登记、绑定、状态、维护 | - | ✅ | ✅（只读） | ✅（全局） |
| 定检计划 | 项目包维护、审批、发布 | - | 只读 | ✅ | ✅（查看） |
| 打卡作业 | 选择项目包/路线/路段、自动开视频 | ✅ | 只读 | 实时监控 | - |
| 视频墙 | 作业中视频展示、对讲 | - | 只读 | ✅ | ✅ |
| 定位轨迹 | 实时定位、轨迹回放 | ✅（仅本人） | ✅ | ✅ | ✅ |
| 数据采集 | 表单、拍照、视频上传 | ✅ | 审核 | 查看/导出 | 查看 |
| 告警处理 | 接收、确认、闭环 | ✅（本人相关） | ✅ | ✅ | ✅ |
| 报表分析 | KPI 看板、导出 | - | ✅ | ✅ | ✅ |
| 租户运营 | 租户管理、计费监控 | - | - | - | ✅ |

---

### 9. 技术与集成预期
- **前端**：React + TypeScript（PC 管理端、大屏）；微信小程序（或 Taro/uni-app 多端）实现巡检端。
- **移动能力层**：封装定位、视频、对讲、文件上传组件，支持弱网缓存与补传。
- **后端**：微服务架构（设备、作业、视频、告警、租户、报表等服务）；API Gateway 做统一鉴权与流控。
- **通信**：WebRTC/RTMP 推流，SIP/自研对讲服务整合执法记录仪 SDK。
- **数据**：PostgreSQL（业务）、时序数据库/ES（轨迹、日志）、对象存储（音视频）。
- **运维监控**：Prometheus + Grafana、ELK/EFK、链路追踪。

---

### 10. 非功能需求
- **性能**：支持 ≥1000 名检测人员在线，实时视频 ≥100 路并发。
- **可靠性**：全年可用性 ≥99.9%，视频/对讲支持自动重连与断点续传。
- **安全性**：传输加密、敏感操作双因子认证、视频访问鉴权。
- **扩展性**：模块化设计，后续可扩展 AI 分析、更多设备接入。
- **合规性**：符合数据隐私、音视频监管法规，支持日志留存与审计。

---

### 11. 实施建议
- **阶段一（4-6 周）**：需求深化、原型设计、设备 SDK 接口确认。
- **阶段二（12-14 周）**：核心功能开发（定检计划、打卡、视频墙、对讲、定位、告警）。
- **阶段三（4 周）**：联调测试、弱网专项、性能与安全测试。
- **阶段四（2 周）**：试运行、用户培训、运维交付。
- **阶段五（可选）**：智能分析（履约评分模型、风险预测）。

---

### 12. 风险与假设
- 设备 SDK 能力差异可能导致视频/对讲体验不一致，需提前测评。
- 户外网络波动大，须强化弱网策略与离线补传。
- 实时视频带宽压力大，需要 CDN/专线支持。
- 需明确定检数据的存储周期、权限分级与隐私合规要求。

---

### 13. 设备参考（JX-P2 执法记录仪）
- **硬件特性**：IP68 防护、2.4 英寸触摸屏、前后双摄、双 MIC、AI 降噪。
- **核心能力**：1080P 实时回传、本地录像、一键抓拍、PTT 对讲、轨迹记录。
- **安全能力**：信令 / 码流 / 文件全链路加密，支持本地人脸、车牌、安全帽检测。
- **接口**：USB-C、Nano SIM、TF 卡、M6 音频接口等。
- **标准配件**：执法记录仪主机、背夹、电池、充电器、数据线。

> 以上终端型号需与平台 SDK 对接验证，确保打卡后能自动推流、支持对讲和状态回传。

---

### 14. 术语表
- **项目包**：主管单位定义的定检项目集合，通常对应桥梁群或合同标段。
- **路线/路段**：项目包下的具体巡检线路，检测人员打卡时必须选择。
- **打卡**：检测人员现场开工/收工的动作，系统据此控制视频、轨迹采集。
- **作业中**：检测人员已成功打卡且视频推流在线的状态。
- **租户**：平台中的主管单位实体，每个租户内可包含多家执行单位。

---

> 本文档需在每次需求调整、功能上线后同步更新，以保证所有角色对流程和功能的理解保持一致。

### 1. 项目背景
- 上海市桥梁定期检查业务提出数字化监管需求，业主希望实时掌握第三方检测单位的作业情况。
- 业主要求检测人员佩戴智能安全帽或智能对讲机，实现定位、视频、语音三位一体的远程监管。
- 现有履约检查靠业主随机现场抽查实现，检查效率低且缺乏统一展示与履约核查能力。
- 第三方检测单位由上海市道运中心通过招标采购的检测服务商提供，各服务商负责检测的桥梁不同，需要统一纳管。

### 2. 目标与范围
- 在已建立的桥梁管理系统中新增定期检查打卡、在线视频监督的可视化模块。
- 支撑智能设备接入、人员履约核查、远程视频/语音监督等关键场景。
- 分阶段实施：先满足基础监管需求，再逐步扩展智能分析与预测能力。
- 管理市、区两级主管部门与各养护服务商之间的巡查协同，实现跨区域统一监管。

### 3. 目标用户
- 检测人员：获取检测任务（桥梁清单、位置信息等）、检测现场开机打卡、随时接受远程检查指令。
- 检测单位管理人员：采购并管理设备、安排检测人员。
- 业主方监管人员：远程查看位置、视频、对讲，掌握履约情况。
- 运维主管/管理层：掌握整体检查工作质量、效率与风险趋势。
- 市、区两级主管部门：依据管辖范围实时监控巡查执行情况，核查服务商履约。

### 4. 核心能力概述
- 智能硬件接入与管理。
- 人员定位与轨迹追踪。
- 远程视频与语音监督。
- 巡检计划与任务流管理。
- 异常告警与履约核查。
- 数据分析与可视化。
- 系统与权限管理。
- 多级监管视角与区域化管理。

### 5. 业务流程说明

#### 5.0 核心业务流程

**设备采购与登记流程：**
1. 执行单位自行采购设备（如JX-P2执法记录仪）
2. 执行单位管理员在系统中登记设备信息（设备型号、SN码、采购日期、供应商等）
3. 设备登记后需进行绑定激活，关联到执行单位
4. 设备登记完成后，可在排班时选择使用

**定检计划与排班流程：**
1. 主管单位管理员制定定检计划（包含检查路线、桥梁清单、检查时间、检查要求等）
2. 定检计划审批通过后，分派给指定的执行单位
3. 执行单位管理员接收定检计划，查看计划详情
4. 执行单位管理员创建排班计划，必须包含三个核心要素：
   - **人员**：从本单位检测人员中选择
   - **路线**：从接收的定检计划中选择路线/路段
   - **设备**：从本单位已登记且可用的设备中选择
5. 系统自动将排班计划与定检计划匹配，关联桥梁清单、检查要求等信息
6. 排班计划提交后，系统自动生成检测任务并推送给对应检测人员
7. 检测人员在小程序端接收任务，查看完整的任务信息（人员、路线、设备、检查要求等）
8. 主管单位管理员可查看所有执行单位的排班计划详情，掌握人员、路线、设备的分配情况

**任务执行流程：**
1. 检测人员在小程序端查看任务详情（由系统根据定检计划和排班计划匹配返回）
2. 检测人员确认使用排班计划中指定的设备（设备SN码匹配）
3. 检测人员到达现场，进行开机打卡（GPS定位+时间戳）
4. 检测人员按计划路线进行检查，实时上报位置、视频、数据
5. 主管单位管理员可实时查看检测人员位置、视频、对讲，进行远程监督
6. 检测任务完成后，系统自动生成履约评估报告

### 6. 功能需求拆解
- 6.1 设备与人员管理
  - **设备采购与登记**：
    - 执行单位自行采购设备后，需在系统中登记设备信息（设备型号、SN码、采购日期、供应商等）。
    - 设备登记后需进行绑定激活，关联到执行单位。
    - 支持设备信息修改、设备注销等操作。
    - 同一服务商完成多个标段的检测任务时应分标段管理设备。
  - **人员-设备绑定**：
    - 执行单位管理员可将检测人员与设备进行绑定。
    - 支持临时解绑和重新绑定。
    - 绑定关系变更需记录操作日志。
  - **设备状态监控**：
    - 实时监控设备状态（在线/离线、电量、信号强度）。
    - 设备使用情况统计（使用时长、使用频率）。
  - **设备故障与维护记录**：
    - 记录设备故障信息、维修记录、维护计划。
    - 设备维护期间可标记为不可用状态。
- 6.2 定检计划与排班管理
  - **定检计划制定**（主管单位管理员）：
    - 制定定检计划，包含检查路线、桥梁清单、检查时间、检查要求等。
    - 支持按区域、路段、桥梁类型等维度制定计划。
    - 计划审批流程（草稿→待审批→已审批→已下发）。
    - 计划可分配给指定的执行单位。
  - **排班计划管理**（执行单位管理员）：
    - 接收主管单位下发的定检计划。
    - 创建排班计划，必须包含三个核心要素：
      - **人员**：指定执行检测任务的检测人员
      - **路线**：指定检查的路线/路段（来自定检计划）
      - **设备**：指定使用的设备（从本单位已登记设备中选择）
    - 排班计划需与定检计划匹配，系统自动关联定检计划中的桥梁清单、检查要求等信息。
    - 支持批量排班、排班模板、排班调整等功能。
    - 排班计划提交后，系统自动生成检测任务并推送给对应检测人员。
  - **任务信息匹配**：
    - 系统根据定检计划和排班计划，自动匹配并返回给检测人员：
      - 检测人员信息
      - 检查路线和桥梁清单
      - 使用的设备信息
      - 检查时间要求
      - 检查标准和要求
    - 检测人员在小程序端可查看完整的任务信息。
  - **排班计划查看**（主管单位管理员）：
    - 可查看所有执行单位的排班计划详情（人员、路线、设备）。
    - 支持按时间、执行单位、路线等维度筛选查看。
    - 排班计划变更需通知主管单位。
- 6.3 人员定位与轨迹
  - 实时位置展示，可切换地图视角（桥梁、线路、重点区域）。
  - 历史轨迹回放，支持时间区间过滤与轨迹对比。
  - 轨迹合规性校验（是否按计划路线检查、停留时长分析）。
  - 支持按人员、设备、路线等维度查看轨迹。
- 6.4 远程监督
  - 远程开启摄像头查看实时视频，支持画面抓拍、录像存证。
  - 实时语音对讲，记录对讲内容和发起人。
  - 远程任务指令下发与确认反馈。
- 6.5 履约核查与异常告警
  - 自动记录检查轨迹、作业时长，生成履约评估。
  - 告警规则配置（偏离桥梁所在位置、设备离线、长时间静止）。
  - 告警通知（平台消息、短信/邮件可选）与闭环处理流程。
- 6.6 数据分析与报表
  - 定检执行统计（完成率、异常次数、人员绩效），支持按市级/区级/服务商维度查看。
  - 设备使用率、故障率分析。
  - 报表自定义与导出（Excel/PDF），支持定时推送。
- 6.7 系统与权限管理
  - 用户、角色、数据权限配置（按行政层级、服务商、区域、桥梁分级）。
  - 接口与日志审计，支持操作追溯。
  - 平台参数配置（地图底图、告警阈值、设备型号）。

### 7. 非功能需求
- 性能：支持不少于1000名检测人员及100路实时视频并发访问。
- 安全：定位、音视频数据全程加密传输，支持多因素登录。
- 可用性：全年系统可用性≥99.9%，关键功能支持故障自动切换。
- 可扩展性：模块化架构，支持后续接入更多智能终端。
- 合规：符合数据隐私与视频监管相关法规。

### 8. 技术与集成预期
- 前端：基于React或Vue实现Web端监管大屏与管理界面；支持WebRTC/RTMP视频播放。
- 移动端：支持H5与原生SDK接入，兼容智能安全帽/对讲机终端能力。
- 后端：微服务架构，提供标准化 API 与设备接入网关，支持MQ或流媒体服务。
- 数据层：关系型数据库用于业务数据，时序数据库/大数据平台存储轨迹与视频元数据。
- 第三方集成：与智能设备厂商平台、短信网关、地图服务对接。
- 部署：容器化部署，具备CI/CD与运维监控能力。

### 9. 实施里程碑建议
- 阶段一（4-6周）：需求调研、原型设计、设备接口确认。
- 阶段二（12-16周）：核心功能开发（设备管理、定位、视频、语音、计划、告警）。
- 阶段三（4周）：联调测试、性能与安全专项。
- 阶段四（2周）：试运行与用户培训，收集优化意见。

### 10. 风险与假设
- 设备厂商接口稳定性与开放性存在差异，需要提前评估和对齐协议。
- 户外网络环境复杂，需考虑弱网、离线缓存与数据补传机制。
- 实时视频与定位数据量大，对带宽与存储提出更高要求。
- 人员隐私与数据合规要求高，需明确授权与存储规范。

### 11. 设备参考说明（JX-P2 执法记录仪）
- **设备定位**：建勖信息推出的经济型4G智能执法记录仪，符合GA/T 947-2015行业标准。
- **硬件特性**
  - IP68防护等级，可抗2米自由跌落。
  - 2.4英寸高清触摸屏；前置500万、后置200万像素星光级摄像头，可外接USB高清摄像头。
  - 内置2W专业喇叭（峰值2.5W）、双MIC，支持AI降噪与回声消除。
- **核心功能**
  - 视音频采集记录、1080P实时/本地录像及回传、集群对讲（可视对讲/语音对讲，含PTT实体按键）。
  - 自主流媒体算法，确保清晰、低延迟的远程视频传输。
  - 轨迹跟踪、一键求援、离线存储后补传。
- **安全能力**：信令/码流/文件全链路加密。
- **智能分析**：内置人脸比对、车牌识别、安全帽检测等端侧AI算法。
- **系统兼容**：支持安装第三方应用，可与平台实现远程监督、指挥调度联动。
- **硬件接口**
  - 左侧：照明键（短按照明、长按红蓝爆闪）、电源键（长按开关机、短按待机/唤醒）、13针M6通用音频接口（兼容耳机/手咪）。
  - 右侧：PTT对讲键；音量键（调节音量，长按音量+开启/关闭夜视，长按音量-标记重点片段）。
  - 背部：抓拍键、录像键（长按2秒开始，再按结束）。
  - 内部：Nano SIM卡槽、TF卡槽。
  - 底部：USB Type-C（充电、数据、外接USB耳机/摄像头）。
- **规格参数**
  - 基本：品牌睿极视畅®，型号P2，IP68，Android 12.0，四核2.0GHz，2GB RAM / 8GB ROM，TF卡扩展至256GB。
  - 外观：黑灰色，100×59×28mm，196g（含电池背夹），触摸+实体按键。
  - 屏幕：2.4英寸康宁玻璃电容屏，480×640，支持强光可视。
  - 网络：国内4G全网通（TDD/FDD频段）、GSM、WCDMA；支持2.4G 802.11 b/g/n Wi-Fi及蓝牙。
  - 音视频：后置200万星光级镜头（≥108°、畸变<10%）、前置500万、双红外灯自动切换、双LED白光灯、2W喇叭、双MIC AI降噪。
  - 摄录：视频H.264、音频AAC/ADPCM，本地录像RAV加密（1080P/720P/VGA/D1），抓拍JPEG最高200万像素。
  - 电池：可拆卸4.4V 3800mAh主电池（1080P连续录制10小时），标配5V/2A充电器（可选9V/2A），内置50mAh备用电池实现热插拔。
  - 传感器：北斗/GPS/GLONASS定位，光感、陀螺仪。
  - 其他：支持NFC、USB-C 2.0、M6音频接口、公网对讲、震动马达、红蓝爆闪、三色信号灯，工作温度-30℃~+55℃、仓储-40℃~+70℃。
  - 标配：背夹、电池、充电器、数据线。
- **主要功能概述**
  - 集群通话：PTT即时指挥、全员收听。
  - 视频/语音通话：双向音视频对讲，通话中可录像、抓拍。
  - 视频采集：任意界面响应平台预览请求，支持本地预览、同步上传定位/声音，物理键录像/抓拍。
  - 平台连线：平台可联动显示视频、双向对讲，并远程指挥录像/抓拍。
  - 实时预览：平台端批量查看实时画面，可执行喊话、对讲、录像、抓拍、云台控制。
  - 电子地图：显示定位设备，支持轨迹跟踪与视频预览。
  - 查询回放：支持平台/前端/本地存储检索录像与图片。
  - 文件管理：本地音视频回放、图片浏览、一键上传。
  - 一键类操作：报警、录像、抓拍、录音、标记等物理按键快捷操作。
  - 智能分析：本地/后台人脸识别、车牌识别；安全帽佩戴检测（含颜色识别）。

